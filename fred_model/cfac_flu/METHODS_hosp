#!/bin/bash
#
# METHODS file to perform a flexible parameter sweep on HOSPITALIZATION probabilities.
#
# HOW TO USE:
# Configure the parameter arrays in the section below.
#
# - To SWEEP a parameter: List multiple values separated by spaces.
#   Example: SWEEP_YR50_TO_YR64_HOS_PROB=(0.008 0.010 0.012)
#
# - To FIX a parameter: List only a single value.
#   Example: SWEEP_YR18_TO_YR49_HOS_PROB=(0.002)
#
# The script will submit a job for every possible combination of the listed values.
#

echo "--- Starting FRED Influenza Hospitalization Probability Sweep ---"

# ==============================================================================
# --- HOSPITALIZATION SWEEP CONFIGURATION ---
# Adjust the arrays below to define the sweep. Hospitalization rates are
# probabilities (0.0 to 1.0) and are typically very low values.
# ==============================================================================

# Example: Sweeping the 50-64 and 65+ age groups while others are fixed.
SWEEP_YR0_TO_YR4_HOS_PROB=(0.009190606)
SWEEP_YR5_TO_YR17_HOS_PROB=(0.009510279)
SWEEP_YR18_TO_YR49_HOS_PROB=(0.032577915)
SWEEP_YR50_TO_YR64_HOS_PROB=(0.062108743) # <-- Sweeping 3 values
SWEEP_YR65_PLUS_HOS_PROB=(0.20 0.3 0.4)   # <-- Sweeping 3 values

#   if (Vax<1,age>=65) then next(Died) with prob(0.109740115)
#   if (Vax<1,range(age,50,64)) then next(Died) with prob(0.062108743)
#   if (Vax<1,range(age,18,49)) then next(Died) with prob(0.032577915)
#   if (Vax<1,range(age,5,17)) then next(Died) with prob(0.009510279)
#   if (Vax<1,range(age,0,4)) then next(Died) with prob(0.009190606)

# ==============================================================================
# --- FIXED BACKGROUND PARAMETERS ---
# These parameters are held constant during the hospitalization sweep.
# ==============================================================================

# Fixed Asymptomatic Probabilities
FIXED_YR0_TO_YR4_ASYMP_PROB=0.5
FIXED_YR5_TO_YR17_ASYMP_PROB=1.0
FIXED_YR18_TO_YR49_ASYMP_PROB=1.0
FIXED_YR50_TO_YR64_ASYMP_PROB=0.0

# Fixed Vaccination Rates
FIXED_MO6_TO_YR17_VAX=0.554
FIXED_YR18_TO_YR49_VAX=0.328
FIXED_YR50_TO_YR64_VAX=0.462
FIXED_YR65_PLUS_VAX=0.697


# --- Parameter Sweep Loop ---

job_count=0
echo ">>> Beginning parameter sweep loop..."

for hos_prob_0_4 in "${SWEEP_YR0_TO_YR4_HOS_PROB[@]}"
do
  for hos_prob_5_17 in "${SWEEP_YR5_TO_YR17_HOS_PROB[@]}"
  do
    for hos_prob_18_49 in "${SWEEP_YR18_TO_YR49_HOS_PROB[@]}"
    do
      for hos_prob_50_64 in "${SWEEP_YR50_TO_YR64_HOS_PROB[@]}"
      do
        for hos_prob_65p in "${SWEEP_YR65_PLUS_HOS_PROB[@]}"
        do
          # This block runs for each unique combination of parameters
          ((job_count++))
          echo ""
          echo "--- Submitting Job #$job_count ---"
          echo "Parameters: hos_0-4y=$hos_prob_0_4, hos_5-17y=$hos_prob_5_17, hos_18-49y=$hos_prob_18_49, hos_50-64y=$hos_prob_50_64, hos_65+y=$hos_prob_65p"

          # Create the parameter file for the current sweep value
          cat > ./cfac_params.fred << EOF
# --- FRED Simulation Parameters (Generated by hospitalization_sweep.sh) ---

# --- FIXED PARAMETERS ---
# Vaccination Rates
global mo6_to_yr17_vax yr18_to_yr49_vax yr50_to_yr64_vax yr65_plus_vax
mo6_to_yr17_vax = $FIXED_MO6_TO_YR17_VAX
yr18_to_yr49_vax = $FIXED_YR18_TO_YR49_VAX
yr50_to_yr64_vax = $FIXED_YR50_TO_YR64_VAX
yr65_plus_vax = $FIXED_YR65_PLUS_VAX

# Asymptomatic Probabilities
global yr0_to_yr4_asymp_prob yr5_to_yr17_asymp_prob yr18_to_yr49_asymp_prob yr50_to_yr64_asymp_prob
yr0_to_yr4_asymp_prob = $FIXED_YR0_TO_YR4_ASYMP_PROB
yr5_to_yr17_asymp_prob = $FIXED_YR5_TO_YR17_ASYMP_PROB
yr18_to_yr49_asymp_prob = $FIXED_YR18_TO_YR49_ASYMP_PROB
yr50_to_yr64_asymp_prob = $FIXED_YR50_TO_YR64_ASYMP_PROB

# --- SWEPT PARAMETERS ---
# Hospitalization Probabilities
global yr0_to_yr4_hos_prob yr5_to_yr17_hos_prob yr18_to_yr49_hos_prob yr50_to_yr64_hos_prob yr65_plus_hos_prob
yr0_to_yr4_hos_prob = $hos_prob_0_4
yr5_to_yr17_hos_prob = $hos_prob_5_17
yr18_to_yr49_hos_prob = $hos_prob_18_49
yr50_to_yr64_hos_prob = $hos_prob_50_64
yr65_plus_hos_prob = $hos_prob_65p
EOF

          # Generate a unique key. 'h' for hospitalization.
          h0_4_key=$(echo "$hos_prob_0_4" | tr '.' 'p')
          h5_17_key=$(echo "$hos_prob_5_17" | tr '.' 'p')
          h18_49_key=$(echo "$hos_prob_18_49" | tr '.' 'p')
          h50_64_key=$(echo "$hos_prob_50_64" | tr '.' 'p')
          h65p_key=$(echo "$hos_prob_65p" | tr '.' 'p')
          FRED_KEY="cfac_flu_HOS_sweep_h0-4_${h0_4_key}__h5-17_${h5_17_key}__h18-49_${h18_49_key}__h50-64_${h50_64_key}__h65p_${h65p_key}"

          # Delete any existing simulation with this specific key before running
          echo ">>> Deleting existing key (if any): $FRED_KEY"
          fred_delete -f -k "$FRED_KEY"

          # Run the FRED job with the unique key
          echo ">>> Submitting FRED job with key: $FRED_KEY"
          fred_job -k "$FRED_KEY" -p influenzamodel.fred -t 4 -n 3

        done
      done
    done
  done
done

echo ""
echo "--- All sweep combinations submitted. Total jobs: $job_count ---"