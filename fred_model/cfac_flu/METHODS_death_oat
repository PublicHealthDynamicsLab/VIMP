#!/bin/bash
#
# METHODS file to perform a flexible, one-at-a-time (OAT) parameter sweep
# on DEATH probabilities for a FRED simulation.
#
# HOW TO USE:
# 1. Set the BASELINE value for each parameter. This is the default value.
# 2. For each parameter you want to sweep, list its values in the corresponding
#    SWEEP array.
# 3. If you do NOT want to sweep a parameter, leave its SWEEP array empty or
#    comment it out.
#
# The script will first run a single simulation with all BASELINE values.
# Then, for each parameter with a defined SWEEP array, it will iterate through
# those values while keeping all other parameters fixed at their BASELINE.
#

echo "--- Starting FRED Influenza Death Probability OAT Sweep ---"

# ==============================================================================
# --- OAT SWEEP CONFIGURATION ---
# ==============================================================================

# --- 1. Set BASELINE Parameters for Death Probabilities ---
# These are the default values for the death probabilities in the simulation.
# You can adjust these baseline values as needed.
BASELINE_YR0_TO_YR4_DEATH_PROB=0.009190606
BASELINE_YR5_TO_YR17_DEATH_PROB=0.009510279
BASELINE_YR18_TO_YR49_DEATH_PROB=0.032577915
BASELINE_YR50_TO_YR64_DEATH_PROB=0.062108743
BASELINE_YR65_PLUS_DEATH_PROB=0.109740115
#   if (Vax<1,age>=65) then next(Died) with prob(0.109740115)
#   if (Vax<1,range(age,50,64)) then next(Died) with prob(0.062108743)
#   if (Vax<1,range(age,18,49)) then next(Died) with prob(0.032577915)
#   if (Vax<1,range(age,5,17)) then next(Died) with prob(0.009510279)
#   if (Vax<1,range(age,0,4)) then next(Died) with prob(0.009190606)
# --- 2. Define SWEEP Values for Death Probabilities of Interest ---
# For any death probability parameter you want to sweep, list the values here.
# To skip sweeping a parameter, leave the array empty: e.g., SWEEP_...=()
SWEEP_YR0_TO_YR4_DEATH_PROB=(0.0133 0.0166 0.02)
SWEEP_YR5_TO_YR17_DEATH_PROB=()
SWEEP_YR18_TO_YR49_DEATH_PROB=(0.025 0.02)
SWEEP_YR50_TO_YR64_DEATH_PROB=()
SWEEP_YR65_PLUS_DEATH_PROB=(0.1 0.09 0.08 0.06)


# ==============================================================================
# --- FIXED BACKGROUND PARAMETERS ---
# These parameters are held constant for all runs.
# Hospitalization probabilities are now fixed as per your request.
# ==============================================================================
FIXED_YR0_TO_YR4_HOS_PROB=0.0133
FIXED_YR5_TO_YR17_HOS_PROB=0.002
FIXED_YR18_TO_YR49_HOS_PROB=0.0045
FIXED_YR50_TO_YR64_HOS_PROB=0.025
FIXED_YR65_PLUS_HOS_PROB=0.25

FIXED_YR0_TO_YR4_ASYMP_PROB=0.5
FIXED_YR5_TO_YR17_ASYMP_PROB=1.0
FIXED_YR18_TO_YR49_ASYMP_PROB=1.0
FIXED_YR50_TO_YR64_ASYMP_PROB=0.0
FIXED_MO6_TO_YR17_VAX=0.554
FIXED_YR18_TO_YR49_VAX=0.328
FIXED_YR50_TO_YR64_VAX=0.462
FIXED_YR65_PLUS_VAX=0.697

# ==============================================================================
# --- CORE JOB SUBMISSION FUNCTION ---
# This function handles file creation, key generation, and job submission.
# DO NOT EDIT unless you need to change the FRED command.
# Arguments:
# $1: death_prob_0_4
# $2: death_prob_5_17
# $3: death_prob_18_49
# $4: death_prob_50_64
# $5: death_prob_65p
# ==============================================================================
job_count=0
run_fred_job() {
    local death_prob_0_4=$1
    local death_prob_5_17=$2
    local death_prob_18_49=$3
    local death_prob_50_64=$4
    local death_prob_65p=$5

    ((job_count++))
    echo ""
    echo "--- Submitting Job #$job_count ---"
    echo "Parameters: death_0-4y=$death_prob_0_4, death_5-17y=$death_prob_5_17, death_18-49y=$death_prob_18_49, death_50-64y=$death_prob_50_64, death_65+y=$death_prob_65p"

    # Create the parameter file for the current run
    cat > ./cfac_params.fred << EOF
# --- FRED Simulation Parameters (Generated by OAT_sweep.sh) ---

# --- FIXED PARAMETERS ---
global mo6_to_yr17_vax yr18_to_yr49_vax yr50_to_yr64_vax yr65_plus_vax
mo6_to_yr17_vax = $FIXED_MO6_TO_YR17_VAX
yr18_to_yr49_vax = $FIXED_YR18_TO_YR49_VAX
yr50_to_yr64_vax = $FIXED_YR50_TO_YR64_VAX
yr65_plus_vax = $FIXED_YR65_PLUS_VAX

global yr0_to_yr4_asymp_prob yr5_to_yr17_asymp_prob yr18_to_yr49_asymp_prob yr50_to_yr64_asymp_prob
yr0_to_yr4_asymp_prob = $FIXED_YR0_TO_YR4_ASYMP_PROB
yr5_to_yr17_asymp_prob = $FIXED_YR5_TO_YR17_ASYMP_PROB
yr18_to_yr49_asymp_prob = $FIXED_YR18_TO_YR49_ASYMP_PROB
yr50_to_yr64_asymp_prob = $FIXED_YR50_TO_YR64_ASYMP_PROB

global yr0_to_yr4_hos_prob yr5_to_yr17_hos_prob yr18_to_yr49_hos_prob yr50_to_yr64_hos_prob yr65_plus_hos_prob
yr0_to_yr4_hos_prob = $FIXED_YR0_TO_YR4_HOS_PROB
yr5_to_yr17_hos_prob = $FIXED_YR5_TO_YR17_HOS_PROB
yr18_to_yr49_hos_prob = $FIXED_YR18_TO_YR49_HOS_PROB
yr50_to_yr64_hos_prob = $FIXED_YR50_TO_YR64_HOS_PROB
yr65_plus_hos_prob = $FIXED_YR65_PLUS_HOS_PROB

# --- SWEPT/BASELINE PARAMETERS ---
global yr0_to_yr4_death_prob yr5_to_yr17_death_prob yr18_to_yr49_death_prob yr50_to_yr64_death_prob yr65_plus_death_prob
yr0_to_yr4_death_prob = $death_prob_0_4
yr5_to_yr17_death_prob = $death_prob_5_17
yr18_to_yr49_death_prob = $death_prob_18_49
yr50_to_yr64_death_prob = $death_prob_50_64
yr65_plus_death_prob = $death_prob_65p
EOF

    # Generate a unique key based on the parameters
    local d0_4_key=$(echo "$death_prob_0_4" | tr '.' 'p')
    local d5_17_key=$(echo "$death_prob_5_17" | tr '.' 'p')
    local d18_49_key=$(echo "$death_prob_18_49" | tr '.' 'p')
    local d50_64_key=$(echo "$death_prob_50_64" | tr '.' 'p')
    local d65p_key=$(echo "$death_prob_65p" | tr '.' 'p')
    local FRED_KEY="cfac_flu_DEATH_OAT_d0-4_${d0_4_key}__d5-17_${d5_17_key}__d18-49_${d18_49_key}__d50-64_${d50_64_key}__d65p_${d65p_key}"

    echo ">>> Deleting existing key (if any): $FRED_KEY"
    fred_delete -f -k "$FRED_KEY" # Uncomment this line if you want to delete existing keys before submitting

    echo ">>> Submitting FRED job with key: $FRED_KEY"
    fred_job -k "$FRED_KEY" -p influenzamodel.fred -t 4 -n 3
}

# ==============================================================================
# --- SWEEP EXECUTION LOGIC ---
# ==============================================================================

# --- 1. Run the Baseline Simulation ---
echo ">>> Submitting the main BASELINE run..."
run_fred_job \
    "$BASELINE_YR0_TO_YR4_DEATH_PROB" \
    "$BASELINE_YR5_TO_YR17_DEATH_PROB" \
    "$BASELINE_YR18_TO_YR49_DEATH_PROB" \
    "$BASELINE_YR50_TO_YR64_DEATH_PROB" \
    "$BASELINE_YR65_PLUS_DEATH_PROB"

# --- Sweep YR0_TO_YR4_DEATH_PROB ---
if [ ${#SWEEP_YR0_TO_YR4_DEATH_PROB[@]} -gt 0 ]; then
    echo ""
    echo ">>> Sweeping YR0_TO_YR4_DEATH_PROB..."
    for val in "${SWEEP_YR0_TO_YR4_DEATH_PROB[@]}"; do
        if [ "$val" == "$BASELINE_YR0_TO_YR4_DEATH_PROB" ]; then continue; fi
        run_fred_job \
            "$val" \
            "$BASELINE_YR5_TO_YR17_DEATH_PROB" \
            "$BASELINE_YR18_TO_YR49_DEATH_PROB" \
            "$BASELINE_YR50_TO_YR64_DEATH_PROB" \
            "$BASELINE_YR65_PLUS_DEATH_PROB"
    done
fi

# --- Sweep YR5_TO_YR17_DEATH_PROB ---
if [ ${#SWEEP_YR5_TO_YR17_DEATH_PROB[@]} -gt 0 ]; then
    echo ""
    echo ">>> Sweeping YR5_TO_YR17_DEATH_PROB..."
    for val in "${SWEEP_YR5_TO_YR17_DEATH_PROB[@]}"; do
        if [ "$val" == "$BASELINE_YR5_TO_YR17_DEATH_PROB" ]; then continue; fi
        run_fred_job \
            "$BASELINE_YR0_TO_YR4_DEATH_PROB" \
            "$val" \
            "$BASELINE_YR18_TO_YR49_DEATH_PROB" \
            "$BASELINE_YR50_TO_YR64_DEATH_PROB" \
            "$BASELINE_YR65_PLUS_DEATH_PROB"
    done
fi

# --- Sweep YR18_TO_YR49_DEATH_PROB ---
if [ ${#SWEEP_YR18_TO_YR49_DEATH_PROB[@]} -gt 0 ]; then
    echo ""
    echo ">>> Sweeping YR18_TO_YR49_DEATH_PROB..."
    for val in "${SWEEP_YR18_TO_YR49_DEATH_PROB[@]}"; do
        if [ "$val" == "$BASELINE_YR18_TO_YR49_DEATH_PROB" ]; then continue; fi
        run_fred_job \
            "$BASELINE_YR0_TO_YR4_DEATH_PROB" \
            "$BASELINE_YR5_TO_YR17_DEATH_PROB" \
            "$val" \
            "$BASELINE_YR50_TO_YR64_DEATH_PROB" \
            "$BASELINE_YR65_PLUS_DEATH_PROB"
    done
fi

# --- Sweep YR50_TO_YR64_DEATH_PROB ---
if [ ${#SWEEP_YR50_TO_YR64_DEATH_PROB[@]} -gt 0 ]; then
    echo ""
    echo ">>> Sweeping YR50_TO_YR64_DEATH_PROB..."
    for val in "${SWEEP_YR50_TO_YR64_DEATH_PROB[@]}"; do
        if [ "$val" == "$BASELINE_YR50_TO_YR64_DEATH_PROB" ]; then continue; fi
        run_fred_job \
            "$BASELINE_YR0_TO_YR4_DEATH_PROB" \
            "$BASELINE_YR5_TO_YR17_DEATH_PROB" \
            "$BASELINE_YR18_TO_YR49_DEATH_PROB" \
            "$val" \
            "$BASELINE_YR65_PLUS_DEATH_PROB"
    done
fi

# --- Sweep YR65_PLUS_DEATH_PROB ---
if [ ${#SWEEP_YR65_PLUS_DEATH_PROB[@]} -gt 0 ]; then
    echo ""
    echo ">>> Sweeping YR65_PLUS_DEATH_PROB..."
    for val in "${SWEEP_YR65_PLUS_DEATH_PROB[@]}"; do
        if [ "$val" == "$BASELINE_YR65_PLUS_DEATH_PROB" ]; then continue; fi
        run_fred_job \
            "$BASELINE_YR0_TO_YR4_DEATH_PROB" \
            "$BASELINE_YR5_TO_YR17_DEATH_PROB" \
            "$BASELINE_YR18_TO_YR49_DEATH_PROB" \
            "$BASELINE_YR50_TO_YR64_DEATH_PROB" \
            "$val"
    done
fi

echo ""
echo "--- All OAT sweep combinations submitted. Total jobs: $job_count ---"
