#!/bin/bash
#
# This script runs a series of FRED simulations to evaluate different
# vaccination rate scenarios (current, decrease, and increase) while
# holding other key parameters fixed.
#

echo "--- Starting FRED Vaccination Rate Scenario Simulations ---"

# ==============================================================================
# --- FIXED BACKGROUND PARAMETERS ---
# These parameters are held constant for all runs.
# ==============================================================================

# --- Fixed Asymptomatic Probabilities ---
FIXED_YR0_TO_YR4_ASYMP_PROB=0.5
FIXED_YR5_TO_YR17_ASYMP_PROB=1.0
FIXED_YR18_TO_YR49_ASYMP_PROB=1.0
FIXED_YR50_TO_YR64_ASYMP_PROB=0.0

# --- Fixed Hospitalization Probabilities ---
FIXED_YR0_TO_YR4_HOS_PROB=0.0133
FIXED_YR5_TO_YR17_HOS_PROB=0.002
FIXED_YR18_TO_YR49_HOS_PROB=0.0045
FIXED_YR50_TO_YR64_HOS_PROB=0.025
FIXED_YR65_PLUS_HOS_PROB=0.25

# --- Fixed Death Probabilities (with 65+ override) ---
FIXED_YR0_TO_YR4_DEATH_PROB=0.009190606
FIXED_YR5_TO_YR17_DEATH_PROB=0.009510279
FIXED_YR18_TO_YR49_DEATH_PROB=0.032577915
FIXED_YR50_TO_YR64_DEATH_PROB=0.062108743
FIXED_YR65_PLUS_DEATH_PROB=0.08

# ==============================================================================
# --- VACCINATION RATE SCENARIOS ---
# The scenarios below modify these baseline vaccination rates.
# ==============================================================================

# Store original vaccination rate values as baselines for the scenarios
ORIG_MO6_TO_YR17_VAX=0.554
ORIG_YR18_TO_YR49_VAX=0.328
ORIG_YR50_TO_YR64_VAX=0.462
ORIG_YR65_PLUS_VAX=0.697

# ==============================================================================
# --- CORE JOB SUBMISSION FUNCTION ---
# This function creates the parameter file and submits the job.
# It now includes all fixed parameters and the scenario-specific vaccination rates.
# Arguments:
# $1: scenario_key
# $2: vax_0_17
# $3: vax_18_49
# $4: vax_50_64
# $5: vax_65p
# ==============================================================================
run_fred_job() {
    local scenario_key=$1
    local vax_0_17=$2
    local vax_18_49=$3
    local vax_50_64=$4
    local vax_65p=$5

    echo ""
    echo "--- Submitting Scenario: $scenario_key ---"
    echo "Vaccination Rates: 0-17y=$vax_0_17, 18-49y=$vax_18_49, 50-64y=$vax_50_64, 65+y=$vax_65p"

    # Create the parameter file for the current run
    cat > ./cfac_params.fred << EOF
# --- FRED Simulation Parameters (Generated by Scenario Script) ---

# --- FIXED VACCINATION PARAMETERS (for this scenario) ---
global mo6_to_yr17_vax yr18_to_yr49_vax yr50_to_yr64_vax yr65_plus_vax
mo6_to_yr17_vax = $vax_0_17
yr18_to_yr49_vax = $vax_18_49
yr50_to_yr64_vax = $vax_50_64
yr65_plus_vax = $vax_65p

# --- FIXED ASYMPTOMATIC PROBABILITIES ---
global yr0_to_yr4_asymp_prob yr5_to_yr17_asymp_prob yr18_to_yr49_asymp_prob yr50_to_yr64_asymp_prob
yr0_to_yr4_asymp_prob = $FIXED_YR0_TO_YR4_ASYMP_PROB
yr5_to_yr17_asymp_prob = $FIXED_YR5_TO_YR17_ASYMP_PROB
yr18_to_yr49_asymp_prob = $FIXED_YR18_TO_YR49_ASYMP_PROB
yr50_to_yr64_asymp_prob = $FIXED_YR50_TO_YR64_ASYMP_PROB

# --- FIXED HOSPITALIZATION PROBABILITIES ---
global yr0_to_yr4_hos_prob yr5_to_yr17_hos_prob yr18_to_yr49_hos_prob yr50_to_yr64_hos_prob yr65_plus_hos_prob
yr0_to_yr4_hos_prob = $FIXED_YR0_TO_YR4_HOS_PROB
yr5_to_yr17_hos_prob = $FIXED_YR5_TO_YR17_HOS_PROB
yr18_to_yr49_hos_prob = $FIXED_YR18_TO_YR49_HOS_PROB
yr50_to_yr64_hos_prob = $FIXED_YR50_TO_YR64_HOS_PROB
yr65_plus_hos_prob = $FIXED_YR65_PLUS_HOS_PROB

# --- FIXED DEATH PROBABILITIES ---
global yr0_to_yr4_death_prob yr5_to_yr17_death_prob yr18_to_yr49_death_prob yr50_to_yr64_death_prob yr65_plus_death_prob
yr0_to_yr4_death_prob = $FIXED_YR0_TO_YR4_DEATH_PROB
yr5_to_yr17_death_prob = $FIXED_YR5_TO_YR17_DEATH_PROB
yr18_to_yr49_death_prob = $FIXED_YR18_TO_YR49_DEATH_PROB
yr50_to_yr64_death_prob = $FIXED_YR50_TO_YR64_DEATH_PROB
yr65_plus_death_prob = $FIXED_YR65_PLUS_DEATH_PROB
EOF

    # Delete any existing key and submit the job
    fred_delete -f -k "$scenario_key"
    fred_job -k "$scenario_key" -p influenzamodel.fred -t 4 -n 10
}

# ==============================================================================
# --- EXECUTE SCENARIOS ---
# ==============================================================================

# Run the Baseline Simulation
echo ""
echo ">>> Submitting Baseline 'current' scenario..."
run_fred_job \
    "cfac_flu_current" \
    "$ORIG_MO6_TO_YR17_VAX" \
    "$ORIG_YR18_TO_YR49_VAX" \
    "$ORIG_YR50_TO_YR64_VAX" \
    "$ORIG_YR65_PLUS_VAX"

# ----- DECREASE SCENARIOS -----
echo ""
echo ">>> Submitting Decrease Scenarios..."

# Decrease by 3.9 percentage points in total
run_fred_job \
    "cfac_flu_loomba_3.9pp" \
    "$(echo "$ORIG_MO6_TO_YR17_VAX - .039" | bc -l)" \
    "$(echo "$ORIG_YR18_TO_YR49_VAX - .039" | bc -l)" \
    "$(echo "$ORIG_YR50_TO_YR64_VAX - .039" | bc -l)" \
    "$(echo "$ORIG_YR65_PLUS_VAX - .039" | bc -l)"

# Decrease by 6.2 percentage points in total
run_fred_job \
    "cfac_flu_loomba_6.2pp" \
    "$(echo "$ORIG_MO6_TO_YR17_VAX - .062" | bc -l)" \
    "$(echo "$ORIG_YR18_TO_YR49_VAX - .062" | bc -l)" \
    "$(echo "$ORIG_YR50_TO_YR64_VAX - .062" | bc -l)" \
    "$(echo "$ORIG_YR65_PLUS_VAX - .062" | bc -l)"

# Decrease by 8.5 percentage points in total
run_fred_job \
    "cfac_flu_loomba_8.5pp" \
    "$(echo "$ORIG_MO6_TO_YR17_VAX - .085" | bc -l)" \
    "$(echo "$ORIG_YR18_TO_YR49_VAX - .085" | bc -l)" \
    "$(echo "$ORIG_YR50_TO_YR64_VAX - .085" | bc -l)" \
    "$(echo "$ORIG_YR65_PLUS_VAX - .085" | bc -l)"


# ----- INCREASE SCENARIOS -----
echo ""
echo ">>> Submitting Increase Scenarios..."

# Increase by 2.5% of baseline
run_fred_job \
    "cfac_flu_textmegastudy_2pct" \
    "$(echo "$ORIG_MO6_TO_YR17_VAX * 1.025" | bc -l)" \
    "$(echo "$ORIG_YR18_TO_YR49_VAX * 1.025" | bc -l)" \
    "$(echo "$ORIG_YR50_TO_YR64_VAX * 1.025" | bc -l)" \
    "$(echo "$ORIG_YR65_PLUS_VAX * 1.025" | bc -l)"

# Increase by 4.5% of baseline
run_fred_job \
    "cfac_flu_textmegastudy_4.5pct" \
    "$(echo "$ORIG_MO6_TO_YR17_VAX * 1.045" | bc -l)" \
    "$(echo "$ORIG_YR18_TO_YR49_VAX * 1.045" | bc -l)" \
    "$(echo "$ORIG_YR50_TO_YR64_VAX * 1.045" | bc -l)" \
    "$(echo "$ORIG_YR65_PLUS_VAX * 1.045" | bc -l)"

# Increase by 7% of baseline
run_fred_job \
    "cfac_flu_textmegastudy_7pct" \
    "$(echo "$ORIG_MO6_TO_YR17_VAX * 1.07" | bc -l)" \
    "$(echo "$ORIG_YR18_TO_YR49_VAX * 1.07" | bc -l)" \
    "$(echo "$ORIG_YR50_TO_YR64_VAX * 1.07" | bc -l)" \
    "$(echo "$ORIG_YR65_PLUS_VAX * 1.07" | bc -l)"

echo ""
echo "--- All scenarios submitted. ---"
