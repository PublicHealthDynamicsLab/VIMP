#!/bin/bash
#
# METHODS file to perform a flexible, one-at-a-time (OAT) parameter sweep
# on HOSPITALIZATION probabilities for a FRED simulation.
#
# HOW TO USE:
# 1. Set the BASELINE value for each parameter. This is the default value.
# 2. For each parameter you want to sweep, list its values in the corresponding
#    SWEEP array.
# 3. If you do NOT want to sweep a parameter, leave its SWEEP array empty or
#    comment it out.
#
# The script will first run a single simulation with all BASELINE values.
# Then, for each parameter with a defined SWEEP array, it will iterate through
# those values while keeping all other parameters fixed at their BASELINE.
#

echo "--- Starting FRED Influenza Hospitalization OAT Probability Sweep ---"

# ==============================================================================
# --- OAT SWEEP CONFIGURATION ---
# ==============================================================================

# --- 1. Set BASELINE Parameters ---
# These are the default values for the simulation.
BASELINE_YR0_TO_YR4_HOS_PROB=0.009551139
BASELINE_YR5_TO_YR17_HOS_PROB=0.004195168
BASELINE_YR18_TO_YR49_HOS_PROB=0.007240753
BASELINE_YR50_TO_YR64_HOS_PROB=0.015482932
BASELINE_YR65_PLUS_HOS_PROB=0.096363785
# --- 2. Define SWEEP Values for Parameters of Interest ---
# For any parameter you want to sweep, list the values here.
# To skip sweeping a parameter, leave the array empty: e.g., SWEEP_...=()
SWEEP_YR0_TO_YR4_HOS_PROB=(0.0133 0.0166)
SWEEP_YR5_TO_YR17_HOS_PROB=(0.002) # (0.003 0.002 0.001)
SWEEP_YR18_TO_YR49_HOS_PROB=(0.0045)
SWEEP_YR50_TO_YR64_HOS_PROB=(0.025)
SWEEP_YR65_PLUS_HOS_PROB=(0.25)


# ==============================================================================
# --- FIXED BACKGROUND PARAMETERS ---
# These parameters are held constant for all runs.
# ==============================================================================
FIXED_YR0_TO_YR4_ASYMP_PROB=0.5
FIXED_YR5_TO_YR17_ASYMP_PROB=1.0
FIXED_YR18_TO_YR49_ASYMP_PROB=1.0
FIXED_YR50_TO_YR64_ASYMP_PROB=0.0
FIXED_MO6_TO_YR17_VAX=0.554
FIXED_YR18_TO_YR49_VAX=0.328
FIXED_YR50_TO_YR64_VAX=0.462
FIXED_YR65_PLUS_VAX=0.697

# ==============================================================================
# --- CORE JOB SUBMISSION FUNCTION ---
# This function handles file creation, key generation, and job submission.
# DO NOT EDIT unless you need to change the FRED command.
# Arguments:
# $1: hos_prob_0_4
# $2: hos_prob_5_17
# $3: hos_prob_18_49
# $4: hos_prob_50_64
# $5: hos_prob_65p
# ==============================================================================
job_count=0
run_fred_job() {
    local hos_prob_0_4=$1
    local hos_prob_5_17=$2
    local hos_prob_18_49=$3
    local hos_prob_50_64=$4
    local hos_prob_65p=$5

    ((job_count++))
    echo ""
    echo "--- Submitting Job #$job_count ---"
    echo "Parameters: hos_0-4y=$hos_prob_0_4, hos_5-17y=$hos_prob_5_17, hos_18-49y=$hos_prob_18_49, hos_50-64y=$hos_prob_50_64, hos_65+y=$hos_prob_65p"

    # Create the parameter file for the current run
    cat > ./cfac_params.fred << EOF
# --- FRED Simulation Parameters (Generated by OAT_sweep.sh) ---

# --- FIXED PARAMETERS ---
global mo6_to_yr17_vax yr18_to_yr49_vax yr50_to_yr64_vax yr65_plus_vax
mo6_to_yr17_vax = $FIXED_MO6_TO_YR17_VAX
yr18_to_yr49_vax = $FIXED_YR18_TO_YR49_VAX
yr50_to_yr64_vax = $FIXED_YR50_TO_YR64_VAX
yr65_plus_vax = $FIXED_YR65_PLUS_VAX

global yr0_to_yr4_asymp_prob yr5_to_yr17_asymp_prob yr18_to_yr49_asymp_prob yr50_to_yr64_asymp_prob
yr0_to_yr4_asymp_prob = $FIXED_YR0_TO_YR4_ASYMP_PROB
yr5_to_yr17_asymp_prob = $FIXED_YR5_TO_YR17_ASYMP_PROB
yr18_to_yr49_asymp_prob = $FIXED_YR18_TO_YR49_ASYMP_PROB
yr50_to_yr64_asymp_prob = $FIXED_YR50_TO_YR64_ASYMP_PROB

# --- SWEPT/BASELINE PARAMETERS ---
global yr0_to_yr4_hos_prob yr5_to_yr17_hos_prob yr18_to_yr49_hos_prob yr50_to_yr64_hos_prob yr65_plus_hos_prob
yr0_to_yr4_hos_prob = $hos_prob_0_4
yr5_to_yr17_hos_prob = $hos_prob_5_17
yr18_to_yr49_hos_prob = $hos_prob_18_49
yr50_to_yr64_hos_prob = $hos_prob_50_64
yr65_plus_hos_prob = $hos_prob_65p
EOF

    # Generate a unique key based on the parameters
    local h0_4_key=$(echo "$hos_prob_0_4" | tr '.' 'p')
    local h5_17_key=$(echo "$hos_prob_5_17" | tr '.' 'p')
    local h18_49_key=$(echo "$hos_prob_18_49" | tr '.' 'p')
    local h50_64_key=$(echo "$hos_prob_50_64" | tr '.' 'p')
    local h65p_key=$(echo "$hos_prob_65p" | tr '.' 'p')
    local FRED_KEY="cfac_flu_HOS_OAT_h0-4_${h0_4_key}__h5-17_${h5_17_key}__h18-49_${h18_49_key}__h50-64_${h50_64_key}__h65p_${h65p_key}"

    echo ">>> Uncomment Deleting existing key (if any) if you want: $FRED_KEY"
    fred_delete -f -k "$FRED_KEY"

    echo ">>> Submitting FRED job with key: $FRED_KEY"
    fred_job -k "$FRED_KEY" -p influenzamodel.fred -t 4 -n 3
}

# ==============================================================================
# --- SWEEP EXECUTION LOGIC ---
# ==============================================================================

# --- 1. Run the Baseline Simulation ---
echo ">>> Submitting the main BASELINE run..."
run_fred_job \
    "$BASELINE_YR0_TO_YR4_HOS_PROB" \
    "$BASELINE_YR5_TO_YR17_HOS_PROB" \
    "$BASELINE_YR18_TO_YR49_HOS_PROB" \
    "$BASELINE_YR50_TO_YR64_HOS_PROB" \
    "$BASELINE_YR65_PLUS_HOS_PROB"

# --- Sweep YR0_TO_YR4_HOS_PROB ---
if [ ${#SWEEP_YR0_TO_YR4_HOS_PROB[@]} -gt 0 ]; then
    echo ""
    echo ">>> Sweeping YR0_TO_YR4_HOS_PROB..."
    for val in "${SWEEP_YR0_TO_YR4_HOS_PROB[@]}"; do
        if [ "$val" == "$BASELINE_YR0_TO_YR4_HOS_PROB" ]; then continue; fi
        run_fred_job \
            "$val" \
            "$BASELINE_YR5_TO_YR17_HOS_PROB" \
            "$BASELINE_YR18_TO_YR49_HOS_PROB" \
            "$BASELINE_YR50_TO_YR64_HOS_PROB" \
            "$BASELINE_YR65_PLUS_HOS_PROB"
    done
fi

# --- Sweep YR5_TO_YR17_HOS_PROB ---
if [ ${#SWEEP_YR5_TO_YR17_HOS_PROB[@]} -gt 0 ]; then
    echo ""
    echo ">>> Sweeping YR5_TO_YR17_HOS_PROB..."
    for val in "${SWEEP_YR5_TO_YR17_HOS_PROB[@]}"; do
        if [ "$val" == "$BASELINE_YR5_TO_YR17_HOS_PROB" ]; then continue; fi
        run_fred_job \
            "$BASELINE_YR0_TO_YR4_HOS_PROB" \
            "$val" \
            "$BASELINE_YR18_TO_YR49_HOS_PROB" \
            "$BASELINE_YR50_TO_YR64_HOS_PROB" \
            "$BASELINE_YR65_PLUS_HOS_PROB"
    done
fi

# --- Sweep YR18_TO_YR49_HOS_PROB ---
if [ ${#SWEEP_YR18_TO_YR49_HOS_PROB[@]} -gt 0 ]; then
    echo ""
    echo ">>> Sweeping YR18_TO_YR49_HOS_PROB..."
    for val in "${SWEEP_YR18_TO_YR49_HOS_PROB[@]}"; do
        if [ "$val" == "$BASELINE_YR18_TO_YR49_HOS_PROB" ]; then continue; fi
        run_fred_job \
            "$BASELINE_YR0_TO_YR4_HOS_PROB" \
            "$BASELINE_YR5_TO_YR17_HOS_PROB" \
            "$val" \
            "$BASELINE_YR50_TO_YR64_HOS_PROB" \
            "$BASELINE_YR65_PLUS_HOS_PROB"
    done
fi

# --- Sweep YR50_TO_YR64_HOS_PROB ---
if [ ${#SWEEP_YR50_TO_YR64_HOS_PROB[@]} -gt 0 ]; then
    echo ""
    echo ">>> Sweeping YR50_TO_YR64_HOS_PROB..."
    for val in "${SWEEP_YR50_TO_YR64_HOS_PROB[@]}"; do
        if [ "$val" == "$BASELINE_YR50_TO_YR64_HOS_PROB" ]; then continue; fi
        run_fred_job \
            "$BASELINE_YR0_TO_YR4_HOS_PROB" \
            "$BASELINE_YR5_TO_YR17_HOS_PROB" \
            "$BASELINE_YR18_TO_YR49_HOS_PROB" \
            "$val" \
            "$BASELINE_YR65_PLUS_HOS_PROB"
    done
fi

# --- Sweep YR65_PLUS_HOS_PROB ---
if [ ${#SWEEP_YR65_PLUS_HOS_PROB[@]} -gt 0 ]; then
    echo ""
    echo ">>> Sweeping YR65_PLUS_HOS_PROB..."
    for val in "${SWEEP_YR65_PLUS_HOS_PROB[@]}"; do
        if [ "$val" == "$BASELINE_YR65_PLUS_HOS_PROB" ]; then continue; fi
        run_fred_job \
            "$BASELINE_YR0_TO_YR4_HOS_PROB" \
            "$BASELINE_YR5_TO_YR17_HOS_PROB" \
            "$BASELINE_YR18_TO_YR49_HOS_PROB" \
            "$BASELINE_YR50_TO_YR64_HOS_PROB" \
            "$val"
    done
fi

echo ""
echo "--- All OAT sweep combinations submitted. Total jobs: $job_count ---"
