#!/bin/bash
#
# METHODS file to perform a flexible parameter sweep on asymptomatic probabilities.
#
# HOW TO USE:
# Configure the parameter arrays in the section below.
#
# - To SWEEP a parameter: List multiple values separated by spaces.
#   Example: SWEEP_YR0_TO_YR4=(0.8 0.9 1.0)
#
# - To FIX a parameter: List only a single value.
#   Example: SWEEP_YR18_TO_YR49=(0.6)
#
# The script will submit a job for every possible combination of the listed values.
#

echo "--- Starting FRED Influenza Asymptomatic Probability Sweep ---"

# ==============================================================================
# --- PARAMETER SWEEP CONFIGURATION ---
# Adjust the arrays below to define the sweep.
# The total number of jobs will be the product of the number of items in each list.
# (e.g., 3 values in the first list * 1 value in the second * 2 in the third = 6 jobs)
# ==============================================================================

# User-guided ranges for exploration:
#   - 0-4 y/o:   High end (e.g., 0.6 to 1.0)
#   - 5-17 y/o:  Baseline or adjust as needed
#   - 18-49 y/o: High end (e.g., 0.6 to 1.0)
#   - 50-64 y/o: Low end (e.g., 0.2 down to 0.0)

SWEEP_YR0_TO_YR4=(0.5)
SWEEP_YR5_TO_YR17=(1.0)
SWEEP_YR18_TO_YR49=(1.0) # (0.5 0.75 1.0) # <-- Example of sweeping this parameter
SWEEP_YR50_TO_YR64=(0.0) # <-- Example of sweeping this parameter


# --- FIXED Original Parameters ---
ORIG_MO6_TO_YR17_VAX=0.554
ORIG_YR18_TO_YR49_VAX=0.328
ORIG_YR50_TO_YR64_VAX=0.462
ORIG_YR65_PLUS_VAX=0.697


# --- Parameter Sweep Loop ---

job_count=0
echo ">>> Beginning parameter sweep loop..."

for prob_0_4 in "${SWEEP_YR0_TO_YR4[@]}"
do
  for prob_5_17 in "${SWEEP_YR5_TO_YR17[@]}"
  do
    for prob_18_49 in "${SWEEP_YR18_TO_YR49[@]}"
    do
      for prob_50_64 in "${SWEEP_YR50_TO_YR64[@]}"
      do
        # This block runs for each unique combination of parameters
        ((job_count++))
        echo ""
        echo "--- Submitting Job #$job_count ---"
        echo "Parameters: 0-4y=$prob_0_4, 5-17y=$prob_5_17, 18-49y=$prob_18_49, 50-64y=$prob_50_64"

        # Create the parameter file for the current sweep value
        cat > ./cfac_params.fred << EOF
# --- FRED Simulation Parameters (Generated by sweep.sh) ---
global mo6_to_yr17_vax yr18_to_yr49_vax yr50_to_yr64_vax yr65_plus_vax
mo6_to_yr17_vax = $ORIG_MO6_TO_YR17_VAX
yr18_to_yr49_vax = $ORIG_YR18_TO_YR49_VAX
yr50_to_yr64_vax = $ORIG_YR50_TO_YR64_VAX
yr65_plus_vax = $ORIG_YR65_PLUS_VAX

global yr0_to_yr4_asymp_prob yr5_to_yr17_asymp_prob yr18_to_yr49_asymp_prob yr50_to_yr64_asymp_prob
yr0_to_yr4_asymp_prob = $prob_0_4
yr5_to_yr17_asymp_prob = $prob_5_17
yr18_to_yr49_asymp_prob = $prob_18_49
yr50_to_yr64_asymp_prob = $prob_50_64
EOF

        # Generate a unique and descriptive key for this simulation run
        p0_4_key=$(echo "$prob_0_4" | tr '.' 'p')
        p5_17_key=$(echo "$prob_5_17" | tr '.' 'p')
        p18_49_key=$(echo "$prob_18_49" | tr '.' 'p')
        p50_64_key=$(echo "$prob_50_64" | tr '.' 'p')
        FRED_KEY="cfac_flu_asymp_p0-4_${p0_4_key}__p5-17_${p5_17_key}__p18-49_${p18_49_key}__p50-64_${p50_64_key}"

        # Delete any existing simulation with this specific key before running
        echo ">>> Deleting existing key (if any): $FRED_KEY"
        fred_delete -f -k "$FRED_KEY"

        # Run the FRED job with the unique key
        echo ">>> Submitting FRED job with key: $FRED_KEY"
        fred_job -k "$FRED_KEY" -p influenzamodel.fred -t 4 -n 3

      done
    done
  done
done

echo ""
echo "--- All sweep combinations submitted. Total jobs: $job_count ---"